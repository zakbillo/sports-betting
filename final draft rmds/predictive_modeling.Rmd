---
title: "predictive_modeling"
output:
  github_document:
    df_print: default
  html_document:
    df_print: paged
always_allow_html: true
---

```{r}
library(tidyverse)
library(rvest)
library(httr)
library(jsonlite)
library(glmnet)
library(dplyr)
library(webshot2)
library(scales)
library(knitr)
library(kableExtra)
library(viridis)
library(corrplot)
library(Metrics)
library(kableExtra)
```

## Import data

```{r}
model_clean_2024 = read_csv("data/model_clean_2024.csv")
demographics_2024 = read_csv("data/demographics_2024.csv")
```

## Building predictive model

```{r}
# Build training dataset
training_data <- model_clean_2024 |>
  select(
    State,
    Revenue,
    total_pop,
    median_income,
    pct_bachelors,
    pct_age_20_34,
    pct_urban,
    pct_poverty
  ) |>
  drop_na()   # make sure no missing values in predictors or Revenue
```

```{r}
# Fit linear regression model

# Model: Revenue = β0 + β1 * total_pop + β2 * median_income + ... + error
fit_lm <- lm(
  Revenue ~ total_pop + median_income + pct_bachelors +
    pct_age_20_34 + pct_urban + pct_poverty,
  data = training_data
  )

summary(fit_lm)
```

```{r}
states_no_gambling <-
  demographics_2024 |>
  anti_join(training_data, by = "State")

newdata_illegal <-
  states_no_gambling |>
  select(
    State,
    total_pop,
    median_income,
    pct_bachelors,
    pct_age_20_34,
    pct_urban,
    pct_poverty
  ) |>
  drop_na()  # just in case a state is missing some demographic
```

```{r}
# Predict revenue if these states legalized gambling

pred_illegal <-
  newdata_illegal |>
  mutate(
    predicted_revenue = predict(fit_lm, newdata = newdata_illegal)
  ) |>
  arrange(desc(predicted_revenue))
```

```{r}
# Compare distribution of real vs predicted
summary(training_data$Revenue)
summary(pred_illegal$predicted_revenue)
```

```{r}
# Fit LASSO regression model

# Build design matrix (same predictors as your LM model)
X_train <- model.matrix(
  Revenue ~ total_pop + median_income + pct_bachelors +
    pct_age_20_34 + pct_urban + pct_poverty,
  data = training_data)[, -1]   # remove intercept column (glmnet adds its own)

# Outcome vector
y_train <- training_data$Revenue

set.seed(123)

# Cross-validated LASSO to choose lambda
lasso_cv <- cv.glmnet(
  X_train,
  y_train,
  alpha = 1,          # LASSO penalty
  nfolds = 5,
  standardize = TRUE  # recommended because predictors differ in scale
)

# Final LASSO model at best lambda
lasso_model <- glmnet(
  X_train,
  y_train,
  alpha = 1,
  lambda = lasso_cv$lambda.min,
  standardize = TRUE
)

lasso_cv$lambda.min #This is the penalty 
```

```{r Predictive model}
# Build the prediction matrix for the non-gambling states
X_new <- model.matrix(
  ~ total_pop + median_income + pct_bachelors +
    pct_age_20_34 + pct_urban + pct_poverty,
  data = newdata_illegal)[, -1]   # remove intercept column

# LASSO predictions
pred_illegal_lasso <-
  newdata_illegal |>
  mutate(
    predicted_revenue_lasso = as.numeric(
      predict(lasso_model, newx = X_new)
    )
  ) |>
  arrange(desc(predicted_revenue_lasso))

pred_illegal_lasso <- pred_illegal_lasso |> 
  mutate(predicted_revenue_lasso = pmax(predicted_revenue_lasso, 0))
```

```{r Compare models}
summary(training_data$Revenue)
summary(pred_illegal$predicted_revenue)          # from LM model
summary(pred_illegal_lasso$predicted_revenue_lasso)  # from LASSO model

#LASSO better
```

## Some tables and Figures

Table of Predicted Annual Gambling Revenue for Non-Legal States (LASSO Model)

```{r Tables}
# Clean negative values
pred_illegal_lasso <- pred_illegal_lasso |>
  mutate(predicted_revenue_lasso = pmax(predicted_revenue_lasso, 0))

# Clean and format final table
pred_table <- pred_illegal_lasso |>
  mutate(
    Predicted_Revenue = dollar(predicted_revenue_lasso),
    Population = comma(total_pop),
    Median_Income = dollar(median_income)
  ) |>
  select(
    State,
    Population,
    Median_Income,
    pct_bachelors,
    pct_age_20_34,
    pct_urban,
    pct_poverty,
    Predicted_Revenue
  )

kable(pred_table, format = "html", caption = "Predicted Annual Gambling Revenue for Non-Legal States (LASSO Model)") |>
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))
```

Bar Plot of Predicted Annual Gambling Revenue (if legalized)

```{r Bar Plot}
pred_illegal_lasso_plot <- pred_illegal_lasso |>
  mutate(predicted_revenue_lasso = pmax(predicted_revenue_lasso, 0)) |>
  arrange(predicted_revenue_lasso) |>
  mutate(State = factor(State, levels = State))

ggplot(pred_illegal_lasso_plot, aes(x = State, y = predicted_revenue_lasso)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  scale_y_continuous(labels = dollar) +
  labs(
    title = "Predicted Annual Gambling Revenue (if legalized)",
    subtitle = "LASSO model predictions for states without legal sports gambling",
    x = "",
    y = "Predicted Revenue"
  ) +
  theme_minimal(base_size = 13)
```

Density Plot of Distribution of Actual vs Predicted Gambling Revenue

```{r}
compare_df <- tibble(
  group = c(rep("Actual Revenue (Legal States)", nrow(training_data)),
            rep("Predicted Revenue (Non-Legal States)", nrow(pred_illegal_lasso))),
  revenue = c(training_data$Revenue,
              pred_illegal_lasso$predicted_revenue_lasso)
)

ggplot(compare_df, aes(x = revenue, fill = group)) +
  geom_density(alpha = 0.4) +
  scale_x_continuous(labels = dollar) +
  labs(
    title = "Distribution of Actual vs Predicted Gambling Revenue",
    x = "Revenue",
    y = "Density",
    fill = ""
  ) +
  theme_minimal(base_size = 13)
```

Scatterplot of Population vs Gambling Revenue Comparing Actual and Predicted states

```{r}
scatter_df <- bind_rows(
  training_data |> mutate(type = "Actual Revenue"),
  pred_illegal_lasso |> 
    mutate(Revenue = predicted_revenue_lasso,
           type = "Predicted Revenue")
)

ggplot(scatter_df, aes(x = total_pop, y = Revenue, color = type)) +
  geom_point(size = 3, alpha = 0.7) +
  scale_x_continuous(labels = comma) +
  scale_y_continuous(labels = dollar) +
  labs(
    title = "Population vs Gambling Revenue",
    subtitle = "Comparing actual and predicted states",
    x = "Total Population",
    y = "Revenue",
    color = ""
  ) +
  theme_minimal(base_size = 13)
```

Table of Distribution Comparison of Actual vs. Predicted Revenue

```{r}
summary_table <- tibble(
  Metric = c("Min", "1st Quartile", "Median", "Mean", "3rd Quartile", "Max"),
  Actual_Revenue = summary(training_data$Revenue)[c(1,2,3,4,5,6)],
  Predicted_Revenue = summary(pred_illegal_lasso$predicted_revenue_lasso)[c(1,2,3,4,5,6)]
)

kable(summary_table, format = "html", caption = "Distribution Comparison: Actual vs Predicted Revenue") |>
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))
```

```{r}
# 1. Prepare actual revenue table
actual_table <- training_data %>%
  select(State, Revenue) %>%
  mutate(
    revenue_source = "Actual (Legal States)",
    Revenue = as.numeric(Revenue)
  )

# 2. Prepare predicted revenue table (LASSO)
predicted_table <- pred_illegal_lasso %>%
  select(State, predicted_revenue_lasso) %>%
  rename(Revenue = predicted_revenue_lasso) %>%
  mutate(
    revenue_source = "Predicted (Non-Legal States)"
  )

# 3. Combine both tables
ranked_table <- bind_rows(actual_table, predicted_table) %>%
  arrange(desc(Revenue)) %>%
  mutate(
    Rank = row_number(),
    Revenue = scales::dollar(Revenue)
  ) %>%
  select(Rank, State, Revenue, revenue_source)
```

LASSO Cross-Validation Plot (lamda vs. cross-validation error)

```{r LASSO Cross-Validation Plot (λ vs CV error)}
plot(lasso_cv)
```

LASSO Coefficient Path Plot

```{r LASSO Coefficient Path Plot}
plot(lasso_cv$glmnet.fit, xvar = "lambda", label = TRUE)
```

```{r}
coef_mat <- as.matrix(coef(lasso_cv, s = "lambda.min"))
coef_df <- tibble(
  variable = rownames(coef_mat),
  coefficient = coef_mat[, 1]
) %>%
  filter(variable != "(Intercept)")
```

Plot of Actual vs. Predicted Revenue (LASSO)

```{r Actual vs Predicted}
pred_lasso_train <- as.numeric(predict(lasso_model, newx = X_train))

training_data_lasso <- training_data %>%
mutate(pred_lasso = pred_lasso_train)

ggplot(training_data_lasso, aes(x = Revenue, y = pred_lasso)) +
geom_point(alpha = 0.7, color = "darkgreen") +
geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
scale_x_continuous(labels = dollar) +
scale_y_continuous(labels = dollar) +
labs(
title = "Actual vs Predicted Revenue (LASSO)",
x = "Actual Revenue",
y = "Predicted Revenue"
) +
theme_minimal(base_size = 13)

```

Correlation Map of Potential Predictors

```{r CORR Map}
predictor_mat <- training_data %>%
  select(total_pop, median_income, pct_bachelors, pct_age_20_34,
         pct_urban, pct_poverty) %>%
  as.matrix()

corr_mat <- cor(predictor_mat)

corrplot(
  corr_mat,
  method = "color",
  type = "upper",
  col = viridis(200),   # <-- viridis palette applied here
  tl.col = "black",
  tl.srt = 45
)
```

Scatterplot of Revenue vs. Each Predictor

```{r Rev vs each predictor scatter plot}
plot_df <- training_data %>%
select(Revenue, total_pop, median_income, pct_bachelors,
pct_age_20_34, pct_urban, pct_poverty) %>%
pivot_longer(-Revenue, names_to = "predictor", values_to = "value")

ggplot(plot_df, aes(x = value, y = Revenue)) +
geom_point(alpha = 0.7) +
facet_wrap(~ predictor, scales = "free_x") +
scale_y_continuous(labels = dollar) +
labs(
title = "Revenue vs Key Demographic Predictors (Legal States)",
x = "Predictor Value",
y = "Revenue"
) +
theme_minimal(base_size = 13)
```

Table of Model Performance Comparison Between Linear Model and LASSO

```{r}
# --- Linear Model Predictions ---
lm_pred <- predict(fit_lm)

# --- LASSO Predictions ---
lasso_pred <- as.numeric(predict(lasso_model, newx = X_train))

# --- True values ---
y_true <- training_data$Revenue

# --- Comparison Metrics ---
model_metrics <- tibble(
  Model = c("Linear Model", "LASSO Model"),
  RMSE  = c(rmse(y_true, lm_pred),
            rmse(y_true, lasso_pred)),
  MAE   = c(mae(y_true, lm_pred),
            mae(y_true, lasso_pred)),
  MAPE  = c(mape(y_true, lm_pred),
            mape(y_true, lasso_pred))
)

model_metrics

model_metrics %>%
  mutate(
    RMSE = scales::dollar(RMSE),
    MAE  = scales::dollar(MAE),
    MAPE = scales::percent(MAPE)
  ) %>%
  kable(format = "html", caption = "Model Performance Comparison: Linear Model vs LASSO") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))
```

Column Chart of LASSO Coefficients at Lambda Min

```{r}
coef_mat <- as.matrix(coef(lasso_cv, s = "lambda.min"))

coef_df <- tibble(
  variable = rownames(coef_mat),
  coefficient = coef_mat[, "lambda.min"]
) %>%
  filter(variable != "(Intercept)") %>%
  arrange(desc(abs(coefficient)))

coef_df %>%
  mutate(
    coefficient = scales::comma(coefficient)
  ) %>%
  kable(format = "html", caption = "LASSO Feature Importance (λ_min)") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))

ggplot(coef_df, aes(x = reorder(variable, abs(coefficient)), 
                    y = coefficient, 
                    fill = coefficient > 0)) +
  geom_col() +
  coord_flip() +
  scale_fill_manual(values = c("TRUE" = "#1b9e77", "FALSE" = "#d95f02"),
                    guide = "none") +
  labs(
    title = "LASSO Coefficients at λ_min",
    x = "",
    y = "Coefficient Estimate"
  ) +
  theme_minimal(base_size = 13)

```

We compared a standard linear regression to a LASSO regularized model. Both models have sizeable error due to the extreme variability in state gambling revenues. While the linear model slightly outperforms LASSO in RMSE, the LASSO model achieves a much better MAPE (191% vs 344%), indicating more stable performance for low-revenue states.

LASSO also provides valuable model simplification: only two predictors retain nonzero coefficients—pct_age_20_34 and pct_urban—while income, population, poverty, and education are shrunk to zero. This suggests strong multicollinearity among socioeconomic indicators, with LASSO consolidating their predictive signal into a smaller set of variables. The results highlight that demographic structure (pct_age_20_34) and urbanization are the strongest predictors of sports gambling markets.