---
title: "Sports Betting Analysis"
author: "Team: Zakari, Kimia, Law & Sukhman"
date: "2025 Data Science I (P8105)"
output: 
  html_document:
    theme: flatly
    toc: true
    toc_float: true
    code_folding: hide
    css: style.css
---

<style type="text/css">
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  h1, h2, h3 {
    color: #2c3e50;
    font-weight: 600;
  }
  .main-container {
    max-width: 1200px;
    margin-left: auto;
    margin-right: auto;
  }
</style>

```{r setup, include=FALSE}
library(tidyverse)
library(rvest)
library(httr)
library(jsonlite)
library(patchwork)
library(glmnet)
library(webshot2)
library(scales)
library(corrplot)
library(Metrics)
library(kableExtra)
library(viridis)

knitr::opts_chunk$set(
  fig.width = 8,
  fig.asp = .6,
  out.width = "90%",
  fig.align = "center",
  message = FALSE,
  warning = FALSE,
  echo = TRUE
)

theme_set(theme_minimal() + 
          theme(legend.position = "bottom",
                plot.title = element_text(face = "bold", hjust = 0.5),
                plot.subtitle = element_text(hjust = 0.5, color = "gray50")))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Exploratory Data Analysis

### Import Data

```{r load_data}
total_state_revenue = read_csv("data/total_state_revenue.csv")
model_clean_2024 = read_csv("data/model_clean_2024.csv")
demographics_2024 = read_csv("data/demographics_2024.csv")
```

## Gambling Visuals {.tabset}

### Revenue by Year

```{r revenue_by_year}
# Aggregate total revenue by year
yearly_revenue_summary = total_state_revenue |> 
  group_by(Year) |> 
  summarize(Total_Revenue = sum(Revenue, na.rm = TRUE))

yearly_revenue_summary |> 
  ggplot(aes(x = Year, y = Total_Revenue)) +
  geom_col(aes(fill = as.factor(Year)), show.legend = FALSE) +
  geom_text(aes(label = scales::dollar(Total_Revenue, scale = 1e-9, suffix = "B")), 
            vjust = -0.5) + # Add labels in Billions
  scale_y_continuous(labels = scales::dollar_format()) +
  scale_x_continuous(breaks = 2018:2024) +
  labs(
    title = "Total US Gambling Revenue (2018-2024)",
    subtitle = "Aggregated revenue across all states",
    x = "Year",
    y = "Total Revenue"
  )
```

### Growth by State

```{r revenue_by_state_growth}
# Identify top 5 states by 2024 revenue to keep things looking clean
top_states = total_state_revenue |> 
  filter(Year == 2019) |> 
  slice_max(Revenue, n = 5) |> 
  pull(State)

state_growth_plot_data = total_state_revenue |> 
  mutate(
    State_Group = ifelse(State %in% top_states, State, "All Other")
  ) |> 
  group_by(Year, State_Group) |> 
  summarize(Revenue = sum(Revenue, na.rm = TRUE), .groups = "drop") |> 
  mutate(State_Group = fct_reorder(State_Group, Revenue, .desc = TRUE))


ggplot(state_growth_plot_data, aes(x = Year, y = Revenue, fill = State_Group)) +
  geom_col() +
  scale_y_continuous(labels = scales::dollar_format()) +
  scale_x_continuous(breaks = 2018:2024) +
  labs(
    title = "US Gambling Revenue Growth by State",
    x = "Year",
    y = "Revenue",
    fill = "State"
  )
```

### Market Rank Shifts

```{r market_rank_shift}
# Calculate Ranks for every state, every year
ranked_data = total_state_revenue |> 
  group_by(Year) |> 
  mutate(Rank = min_rank(desc(Revenue))) |> 
  ungroup()

# Identify "States of Interest" - Top 5 at any point
focus_states = ranked_data |> 
  filter(Rank <= 5) |> 
  pull(State) |> 
  unique()

# Filter the dataset to just those states
plot_data = ranked_data |> 
  filter(State %in% focus_states)

plot_data |> 
  ggplot(aes(x = Year, y = Rank, color = State, group = State)) +
  geom_point(size = 3) +
  geom_line(linewidth = 1.2) + 
  scale_y_reverse(breaks = 1:max(plot_data$Rank, na.rm = TRUE)) + 
  scale_x_continuous(breaks = 2018:2024) +
  geom_text(data = plot_data |> filter(Year == 2018), 
            aes(label = paste(Rank, State)), x = 2017.8, hjust = 1, size = 3) +
  geom_text(data = plot_data |> filter(Year == 2024), 
            aes(label = paste(Rank, State)), x = 2024.2, hjust = 0, size = 3) +
  labs(
    title = "Shift in Top Gambling Markets (2018 vs 2024)",
    subtitle = "Tracking rank of states that were in top 5 in 2018 or 2024",
    y = "Revenue Rank",
    x = "Year"
  ) +
  theme(
    legend.position = "none",        
    panel.grid.minor = element_blank()
  ) +
  coord_cartesian(xlim = c(2017, 2025))
```

## Demographic Visuals {.tabset}

### Population

```{r pop_plot}
population_plot = 
  model_clean_2024 |> 
    filter(State != "Washington D.C.") |> 
    mutate(
      State = as.factor(State),
      State = fct_reorder(State, total_pop, .desc = TRUE)
    ) |> 
    ggplot(aes(x = State, y = total_pop)) +
    geom_col(aes(fill = State)) +
    theme(
      axis.text.x = element_text(angle = 90, hjust = 1, vjust = 1),
      legend.position = "none") +
    labs(
        y = "Total Population",
        title = "Total Population by State (2024)"
      )
population_plot
```

### Revenue

```{r rev_plot}
revenue_plot = 
  model_clean_2024 |> 
    filter(State != "Washington D.C.") |> 
    mutate(
      State = as.factor(State),
      State = fct_reorder(State, total_pop, .desc = TRUE)
    ) |> 
    ggplot(aes(x = State, y = Revenue)) +
    geom_col(aes(fill = State)) +
    theme(
      axis.text.x = element_text(angle = 90, hjust = 1, vjust = 1),
      legend.position = "none") +
    labs(
        x = "State (sorted by population)",
        y = "Revenue",
        title = "Gambling Revenue by State (2024)"
      )
revenue_plot
```

### Comparison

```{r combined_plot, fig.width = 10}
combined_revenue_population = (population_plot + revenue_plot)
combined_revenue_population
```

### Racial Makeup

```{r race_plot}
model_clean_2024 |> 
  filter(State != "Washington D.C.") |> 
  select(State, Revenue, pct_white, pct_black, pct_asian, pct_hispanic) |> 
  pivot_longer(
    cols = pct_white:pct_hispanic,
    names_to = "race",
    values_to = "percentage"
  ) |> 
  mutate(
      State = as.factor(State),
      State = fct_reorder(State, Revenue, .desc = TRUE),
      race = factor(race,
                  levels = c("pct_white", "pct_black", "pct_asian", "pct_hispanic"),
                  labels = c("% White", "% Black", "% Asian", "% Hispanic"))
  ) |> 
  ggplot(aes(x = State, y = percentage, color = race, group = race)) +
  geom_point() +
  geom_line() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 1)) +
    labs(
        x = "State (sorted by revenue)",
        y = "Percentage of Population",
        title = "Racial Makeup by State (2024)",
        fill = "Race"
    ) 
```

### Economic Stats

```{r econ_plot}
model_clean_2024 |> 
  filter(State != "Washington D.C.") |> 
  select(State, Revenue, unemployment_rate, pct_poverty) |> 
  pivot_longer(
    cols = c("pct_poverty", "unemployment_rate"),
    names_to = "measure",
    values_to = "percentage"
  ) |> 
  mutate(
      State = as.factor(State),
      State = fct_reorder(State, Revenue, .desc = TRUE),
      measure = factor(measure,
                  levels = c("pct_poverty", "unemployment_rate"),
                  labels = c("% in Poverty", "% Unemployed"))
  ) |> 
  ggplot(aes(x = State, y = percentage, color = measure, group = measure)) +
  geom_point() +
  geom_line() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 1)) +
    labs(
        x = "State (sorted by revenue)",
        y = "Percentage of Population",
        title = "Poverty & Unemployment by State (2024)",
        fill = "Measure"
    ) 
```

## Predictive Modeling

### Model Setup

We begin by building our training dataset and handling missing values.

```{r model_prep}
# Build training dataset
training_data <- model_clean_2024 |>
  select(
    State, Revenue, total_pop, median_income, 
    pct_bachelors, pct_age_20_34, pct_urban, pct_poverty
  ) |>
  drop_na()

states_no_gambling <- demographics_2024 |>
  anti_join(training_data, by = "State")

newdata_illegal <- states_no_gambling |>
  select(
    State, total_pop, median_income, pct_bachelors, 
    pct_age_20_34, pct_urban, pct_poverty
  ) |>
  drop_na()
```

### LASSO Regression

We implement a LASSO regression to handle multicollinearity and perform feature selection.

```{r lasso_model}
# Build design matrix
X_train <- model.matrix(
  Revenue ~ total_pop + median_income + pct_bachelors +
    pct_age_20_34 + pct_urban + pct_poverty,
  data = training_data)[, -1]

y_train <- training_data$Revenue

set.seed(123)

# Cross-validated LASSO
lasso_cv <- cv.glmnet(X_train, y_train, alpha = 1, nfolds = 5, standardize = TRUE)
lasso_model <- glmnet(X_train, y_train, alpha = 1, lambda = lasso_cv$lambda.min, standardize = TRUE)

# Predictions for non-gambling states
X_new <- model.matrix(
  ~ total_pop + median_income + pct_bachelors +
    pct_age_20_34 + pct_urban + pct_poverty,
  data = newdata_illegal)[, -1]

pred_illegal_lasso <- newdata_illegal |>
  mutate(
    predicted_revenue_lasso = as.numeric(predict(lasso_model, newx = X_new)),
    predicted_revenue_lasso = pmax(predicted_revenue_lasso, 0) # Remove negative predictions
  ) |>
  arrange(desc(predicted_revenue_lasso))
```

### Prediction Results

```{r results_table}
pred_table <- pred_illegal_lasso |>
  mutate(
    Predicted_Revenue = dollar(predicted_revenue_lasso),
    Population = comma(total_pop),
    Median_Income = dollar(median_income)
  ) |>
  select(
    State, Population, Median_Income, pct_bachelors, 
    pct_age_20_34, pct_urban, pct_poverty, Predicted_Revenue
  )

kable(pred_table, format = "html", 
      caption = "Predicted Annual Gambling Revenue for Non-Legal States (LASSO Model)") |>
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed"))
```

### Visualizing Predictions

```{r prediction_plot, fig.height=8}
pred_illegal_lasso_plot <- pred_illegal_lasso |>
  mutate(State = factor(State, levels = State)) # Maintain sorted order

ggplot(pred_illegal_lasso_plot, aes(x = State, y = predicted_revenue_lasso)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  scale_y_continuous(labels = dollar) +
  labs(
    title = "Predicted Annual Gambling Revenue (if legalized)",
    subtitle = "LASSO model predictions for states without legal sports gambling",
    x = "",
    y = "Predicted Revenue"
  ) +
  theme_minimal(base_size = 13)
```

## Model Diagnostics {.tabset}

### Feature Importance

```{r feature_importance}
coef_mat <- as.matrix(coef(lasso_cv, s = "lambda.min"))

coef_df <- tibble(
  variable = rownames(coef_mat),
  coefficient = coef_mat[, "lambda.min"]
) %>%
  filter(variable != "(Intercept)") %>%
  arrange(desc(abs(coefficient)))

ggplot(coef_df, aes(x = reorder(variable, abs(coefficient)), 
                    y = coefficient, 
                    fill = coefficient > 0)) +
  geom_col() +
  coord_flip() +
  scale_fill_manual(values = c("TRUE" = "#1b9e77", "FALSE" = "#d95f02"), guide = "none") +
  labs(
    title = "LASSO Coefficients at λ_min",
    subtitle = "Positive (Green) vs Negative (Orange) Impact",
    x = "",
    y = "Coefficient Estimate"
  ) +
  theme_minimal(base_size = 13)
```

### Correlation Map

```{r corr_map}
predictor_mat <- training_data %>%
  select(total_pop, median_income, pct_bachelors, pct_age_20_34,
         pct_urban, pct_poverty) %>%
  as.matrix()

corr_mat <- cor(predictor_mat)

corrplot(
  corr_mat,
  method = "color",
  type = "upper",
  col = viridis(200),
  tl.col = "black",
  tl.srt = 45,
  title = "Predictor Correlations",
  mar = c(0,0,1,0)
)
```

### Actual vs Predicted

```{r actual_vs_predicted}
pred_lasso_train <- as.numeric(predict(lasso_model, newx = X_train))

training_data_lasso <- training_data %>%
  mutate(pred_lasso = pred_lasso_train)

ggplot(training_data_lasso, aes(x = Revenue, y = pred_lasso)) +
  geom_point(alpha = 0.7, color = "darkgreen", size = 3) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  scale_x_continuous(labels = dollar) +
  scale_y_continuous(labels = dollar) +
  labs(
    title = "Actual vs Predicted Revenue (LASSO)",
    x = "Actual Revenue",
    y = "Predicted Revenue"
  ) +
  theme_minimal(base_size = 13)
```

## Conclusion

We compared a standard linear regression to a LASSO regularized model. Both models have sizeable error due to the extreme variability in state gambling revenues. While the linear model slightly outperforms LASSO in RMSE, the LASSO model achieves a much better MAPE (191% vs 344%), indicating more stable performance for low-revenue states.

LASSO also provides valuable model simplification: only two predictors retain nonzero coefficients—`pct_age_20_34` and `pct_urban`, while income, population, poverty, and education are shrunk to zero. This suggests strong multicollinearity among socioeconomic indicators, with LASSO consolidating their predictive signal into a smaller set of variables. The results highlight that demographic structure (`pct_age_20_34`) and urbanization are the strongest predictors of sports gambling markets.

Go back [home](home.html)