---
title: "Sports Betting Analysis"
output: 
  html_document:
    theme: flatly       
    highlight: pygments 
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE}
library(tidyverse)
library(rvest)
library(httr)
library(jsonlite)
library(patchwork)
library(glmnet)
library(webshot2)
library(scales)
library(corrplot)
library(Metrics)
library(kableExtra)
library(viridis)
library(plotly)

knitr::opts_chunk$set(
  fig.width = 8,
  fig.asp = .6,
  out.width = "90%",
  fig.align = "center",
  message = FALSE,
  warning = FALSE,
  echo = TRUE
)

# Increased base size for better readability of demographic plots
theme_set(theme_minimal(base_size = 15) + 
          theme(legend.position = "bottom",
                plot.title = element_text(face = "bold", hjust = 0.5),
                plot.subtitle = element_text(hjust = 0.5, color = "gray50")))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

<style type="text/css">
/* General styling for website compatibility */
body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
h1, h2, h3 {
color: #2c3e50;
font-weight: 600;
}
.main-container {
max-width: 1500px;
margin-left: auto;
margin-right: auto;
}
</style>

# Exploratory Data Analysis

## Import Data

```{r import-data}
total_state_revenue = read_csv("data/total_state_revenue.csv")
model_clean_2024 = read_csv("data/model_clean_2024.csv")
demographics_2024 = read_csv("data/demographics_2024.csv")

# Pre-calculate yearly revenue summary for the Revenue by Year plot
yearly_revenue_summary = total_state_revenue |> 
  group_by(Year) |> 
  summarize(Total_Revenue = sum(Revenue, na.rm = TRUE))

# Pre-calculate data for Growth by State plot
top_states = total_state_revenue |> 
  filter(Year == 2024) |> 
  slice_max(Revenue, n = 5) |> 
  pull(State)

state_growth_plot_data = total_state_revenue |> 
  mutate(
    State_Group = ifelse(State %in% top_states, State, "All Other")
  ) |> 
  group_by(Year, State_Group) |> 
  summarize(Revenue = sum(Revenue, na.rm = TRUE), .groups = "drop") |> 
  mutate(State_Group = fct_reorder(State_Group, Revenue, .desc = TRUE))
```

# Gambling Visuals {.tabset}

## Revenue by Year

```{r revenue-by-year}
# Plotly bar chart showing total revenue by year
plot_ly(
  data = yearly_revenue_summary |> mutate(Year = as.factor(Year)),
  x = ~Year,
  y = ~Total_Revenue, 
  type = "bar", 
  color = ~Year,
  # Use dollar format for text labels
  text = ~scales::dollar(Total_Revenue / 1e9, accuracy = 0.01, suffix = "B"),
  textposition = "outside",
  hoverinfo = "x+y+text"
) |> 
  layout(
    title = "Total US Gambling Revenue (2018-2024)",
    xaxis = list(
      title = "Year"
    ),
    yaxis = list(
      title = "Total Revenue",
      tickformat = "$,"
    ),
    showlegend = FALSE
  )
```

## Growth by State

```{r growth-by-state-fixed}
# Plotly stacked bar chart showing revenue growth by state over time
state_growth_plot_data |> 
  plot_ly(
    x = ~Year,
    y = ~Revenue, 
    type = "bar", 
    color = ~State_Group,
    text = ~scales::dollar(Revenue),
    hoverinfo = "x+y+text"
  ) |> 
  layout(
    title = "US Gambling Revenue Growth by State",
    xaxis = list(
      title = "Year",
      tickvals = 2018:2024
    ),
    yaxis = list(
      title = "Revenue",
      tickformat = "$,"
    ),
    barmode = "stack",
    showlegend = TRUE 
  )
```

## Market Rank Shifts

```{r market-rank-shifts}
# Plotly bar chart showing 2024 Revenue by State, ranked by Revenue (descending)
revenue_2024 = total_state_revenue |> 
  filter(Year == 2024, Revenue > 0) |>
  mutate(
    State = fct_reorder(State, Revenue, .desc = TRUE),
    Rank = min_rank(desc(Revenue))
  )

ordered_states = as.character(revenue_2024$State)

revenue_2024 |> 
  plot_ly(
    x = ~State,
    y = ~Revenue, 
    type = "bar", 
    color = ~State,
    text = ~paste0("Rank ", Rank, ": ", scales::dollar(Revenue, accuracy = 0.01)),
    hoverinfo = "text"
  ) |> 
  layout(
    title = "Gambling Revenue and Market Rank (2024)",
    xaxis = list(
      title = "State (Ranked by Revenue)",
      tickangle = 90,        
      tickmode = "array",           
      tickvals = ordered_states,  
      ticktext = ordered_states
      ),
    yaxis = list(
      title = "Revenue",
      tickformat = "$,"
    ),
    showlegend = FALSE
  )
```

# Demographic Visuals {.tabset}

## Population

```{r population-plot}
# Order by Revenue (descending)
population_plot_data = 
  model_clean_2024 |> 
  filter(State != "Washington D.C.") |> 
  mutate(
    State = as.factor(State),
    State = fct_reorder(State, Revenue, .desc = TRUE) 
  ) |> 
  arrange(State) # Ensure data is physically sorted to match factor order

# Extract the order for the axis
ordered_states = levels(population_plot_data$State)

population_plot = 
  population_plot_data |> 
  plot_ly(
    x = ~State,
    y = ~total_pop, 
    type = "bar", 
    color = ~State,
    text = ~scales::comma(total_pop),
    textposition = "outside",
    hoverinfo = "x+y+text"
    ) |> 
  layout(
    title = "Total Population by State (2024)",
    xaxis = list(
      title = "State (sorted by descending 2024 Revenue)",
      tickangle = 90,        
      tickmode = "array",            
      tickvals = ordered_states,   
      ticktext = ordered_states
      ),
    yaxis = list(
      title = "Total Population"
    ),
    showlegend = FALSE
  )

population_plot
```

## Revenue

```{r revenue-plot}
# Order by Revenue (descending)
revenue_plot_data = 
  model_clean_2024 |> 
  filter(State != "Washington D.C.") |> 
  mutate(
    State = as.factor(State),
    State = fct_reorder(State, Revenue, .desc = TRUE) 
  ) |> 
  arrange(State) # Ensure data is physically sorted

# Extract order
ordered_states = levels(revenue_plot_data$State)

revenue_plot = 
  revenue_plot_data |> 
  plot_ly(
    x = ~State,
    y = ~Revenue, 
    type = "bar", 
    color = ~State,
    text = ~scales::dollar(Revenue),
    textposition = "outside",
    hoverinfo = "x+y+text"
    ) |> 
  layout(
    title = "Gambling Revenue by State (2024)",
    xaxis = list(
      title = "State (sorted by descending 2024 Revenue)",
      tickangle = 90,        
      tickmode = "array",            
      tickvals = ordered_states,   
      ticktext = ordered_states
      ),
    yaxis = list(
      title = "Revenue",
      tickformat = "$,"
    ),
    showlegend = FALSE
  )

revenue_plot
```

## Comparison

```{r combined-plots}
# Use the Plotly objects created in the previous chunks
combined_revenue_population = 
  subplot(
    population_plot, 
    revenue_plot, 
    nrows = 2,       
    shareX = TRUE,     
    shareY = FALSE,
    titleY = TRUE,
    titleX = TRUE
  ) |> 
  layout(
    title = "Population vs Revenue Comparison",
    showlegend = FALSE
  )

combined_revenue_population
```

## Racial Makeup

```{r racial-makeup}
race_plot_data = 
  model_clean_2024 |> 
  filter(State != "Washington D.C.") |> 
  select(State, Revenue, pct_white, pct_black, pct_asian, pct_hispanic) |> 
  pivot_longer(
    cols = pct_white:pct_hispanic,
    names_to = "race",
    values_to = "percentage"
  ) |> 
  mutate(
      State = as.factor(State),
      # 1. Reorder Factor Levels
      State = fct_reorder(State, Revenue, .desc = TRUE), 
      race = factor(race, 
                    levels = c("pct_white", "pct_black", "pct_asian", "pct_hispanic"),
                    labels = c("% White", "% Black", "% Asian", "% Hispanic"))
  ) |> 
  # 2. Arrange rows by State so lines draw sequentially left-to-right
  arrange(State)

# Extract order for consistent axis
ordered_states_race = levels(race_plot_data$State)

race_plot_data |> 
  plot_ly(
    x = ~State,
    y = ~percentage,
    color = ~race,
    type = 'scatter',
    mode = 'lines+markers',
    text = ~paste(State, ": ", sprintf("%.2f%%", percentage)),
    hoverinfo = 'text',          
    line = list(width = 2)
  ) |> 
  layout(
    title = "Racial Makeup by State (Sorted by Revenue)",     
    xaxis = list(
      title = "State",
      tickangle = 90,
      tickmode = "array",
      tickvals = ordered_states_race,
      ticktext = ordered_states_race
    ),
    yaxis = list(
      title = "Percentage of Population", 
      tickformat = ".1f%"
    ),
    showlegend = TRUE
  )
```

## Economic Stats

```{r economic-stats}
economic_plot_data = 
  model_clean_2024 |> 
    filter(State != "Washington D.C.") |> 
    select(State, Revenue, unemployment_rate, pct_poverty) |> 
    pivot_longer(
      cols = c("pct_poverty", "unemployment_rate"),
      names_to = "measure",
      values_to = "percentage"
    ) |> 
    mutate(
        State = as.factor(State),
        # 1. Reorder Factor Levels
        State = fct_reorder(State, Revenue, .desc = TRUE),
        measure = factor(measure, 
                         levels = c("pct_poverty", "unemployment_rate"),
                         labels = c("% in Poverty", "% Unemployed"))
    ) |> 
    # 2. CRITICAL: Arrange rows by State
    arrange(State)

# Extract order
ordered_states_econ = levels(economic_plot_data$State)

economic_plot_data |> 
  plot_ly(
    x = ~State,
    y = ~percentage,
    color = ~measure,
    type = 'scatter',
    mode = 'lines+markers',
    text = ~paste(State, ": ", sprintf("%.2f%%", percentage)),
    hoverinfo = 'text',          
    line = list(width = 2)
  ) |> 
  layout(
    title = "Poverty & Unemployment (Sorted by Revenue)",     
    xaxis = list(
      title = "State",
      tickangle = 90,
      tickmode = "array",
      tickvals = ordered_states_econ,
      ticktext = ordered_states_econ
    ),
    yaxis = list(
      title = "Percentage of Population", 
      tickformat = ".1f%"
    ),
    showlegend = TRUE
  )
```

# Predictive Modeling

## Model Setup

We begin by building our training dataset, fitting a standard linear model for comparison, and handling missing values.

```{r model-setup}
# Build training dataset
training_data <- model_clean_2024 |>
  select(
    State, Revenue, total_pop, median_income, 
    pct_bachelors, pct_age_20_34, pct_urban, pct_poverty
  ) |>
  drop_na()

# Fit Linear Model for later comparison
fit_lm <- lm(
  Revenue ~ total_pop + median_income + pct_bachelors +
    pct_age_20_34 + pct_urban + pct_poverty,
  data = training_data
)

# Prepare Illegal States Data
states_no_gambling <- demographics_2024 |>
  anti_join(training_data, by = "State")

newdata_illegal <- states_no_gambling |>
  select(
    State, total_pop, median_income, pct_bachelors, 
    pct_age_20_34, pct_urban, pct_poverty
  ) |>
  drop_na()
```

## LASSO Regression

We implement a LASSO regression to handle multicollinearity and perform feature selection.

```{r lasso-regression}
# Build design matrix
X_train <- model.matrix(
  Revenue ~ total_pop + median_income + pct_bachelors +
    pct_age_20_34 + pct_urban + pct_poverty,
  data = training_data)[, -1]

y_train <- training_data$Revenue

set.seed(123)

# Cross-validated LASSO
lasso_cv <- cv.glmnet(X_train, y_train, alpha = 1, nfolds = 5, standardize = TRUE)
lasso_model <- glmnet(X_train, y_train, alpha = 1, lambda = lasso_cv$lambda.min, standardize = TRUE)

# Predictions for non-gambling states
X_new <- model.matrix(
  ~ total_pop + median_income + pct_bachelors +
    pct_age_20_34 + pct_urban + pct_poverty,
  data = newdata_illegal)[, -1]

pred_illegal_lasso <- newdata_illegal |>
  mutate(
    predicted_revenue_lasso = as.numeric(predict(lasso_model, newx = X_new)),
    predicted_revenue_lasso = pmax(predicted_revenue_lasso, 0) # Remove negative predictions
  ) |>
  arrange(desc(predicted_revenue_lasso))
```

## Prediction Results

```{r prediction-results}
pred_table <- pred_illegal_lasso |>
  mutate(
    Predicted_Revenue = scales::dollar(predicted_revenue_lasso),
    Population = scales::comma(total_pop),
    Median_Income = scales::dollar(median_income)
  ) |>
  select(
    State, Population, Median_Income, pct_bachelors, 
    pct_age_20_34, pct_urban, pct_poverty, Predicted_Revenue
  )

kable(pred_table, format = "html", 
      caption = "Predicted Annual Gambling Revenue for Non-Legal States (LASSO Model)") |>
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed"))
```

*This table presents the predicted gambling revenue for each state that has not yet legalized sports betting. Using the LASSO model, we estimated annual revenue based on demographic characteristics, including population size, educational attainment, urbanization, and poverty rates. The table shows that states like California, Texas, and Florida have demographic profiles similar to those of current high-revenue states, suggesting substantial untapped market potential if legalization were pursued.*

## Visualizing Predictions

```{r visualizing-predictions}
pred_illegal_lasso_plot <- pred_illegal_lasso |>
  mutate(State = factor(State, levels = State)) # Maintain sorted order

ggplot(pred_illegal_lasso_plot, aes(x = State, y = predicted_revenue_lasso)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  scale_y_continuous(labels = scales::dollar) +
  labs(
    title = "Predicted Annual Gambling Revenue (if legalized)",
    subtitle = "LASSO model predictions for states without legal sports gambling",
    x = "",
    y = "Predicted Revenue"
  ) +
  theme_minimal(base_size = 13)
```

*This bar chart visualizes predicted gambling revenue for each non-legal state, ranked from highest to lowest. Large states with urban populations and strong young-adult demographics (such as California, Texas, and Florida) show the highest predicted revenue, reinforcing the idea that demographic scale influences potential market size. Smaller or more rural states are projected to generate minimal revenue.*

## Distribution of Predictions

```{r distribution-predictions}
compare_df <- tibble(
  group = c(rep("Actual Revenue (Legal States)", nrow(training_data)),
            rep("Predicted Revenue (Non-Legal States)", nrow(pred_illegal_lasso))),
  revenue = c(training_data$Revenue,
              pred_illegal_lasso$predicted_revenue_lasso)
)

ggplot(compare_df, aes(x = revenue, fill = group)) +
  geom_density(alpha = 0.4) +
  scale_x_continuous(labels = scales::dollar) +
  labs(
    title = "Distribution of Actual vs Predicted Gambling Revenue",
    # Set the x-axis title 
    x = "Revenue",
    y = "Density",
    fill = ""
  ) +
  theme_minimal(base_size = 13)
```

*This density plot compares the distribution of observed gambling revenue in legalized states with the predicted revenue for non-legal states. The predicted values span a wider range, with some states projecting higher revenue than current legal markets. This suggests that expansion into a few large states could dramatically reshape the national gambling landscape.*

## Population vs Revenue Comparison

```{r population-revenue-comparison}
scatter_df <- bind_rows(
  training_data |> mutate(type = "Actual Revenue"),
  pred_illegal_lasso |> 
    mutate(Revenue = predicted_revenue_lasso,
           type = "Predicted Revenue")
)

ggplot(scatter_df, aes(x = total_pop, y = Revenue, color = type)) +
  geom_point(size = 3, alpha = 0.7) +
  scale_x_continuous(labels = scales::comma) +
  scale_y_continuous(labels = scales::dollar) +
  labs(
    title = "Population vs Gambling Revenue",
    subtitle = "Comparing actual and predicted states",
    x = "Total Population",
    y = "Revenue",
    color = ""
  ) +
  theme_minimal(base_size = 13)
```

*Here we compare how population relates to revenue in both actual and predicted markets. Larger states show higher revenue but the plot also shows that population alone does not fully explain gambling revenue.*

## Distribution Statistics

```{r distribution-statistics}
summary_table <- tibble(
  Metric = c("Min", "1st Quartile", "Median", "Mean", "3rd Quartile", "Max"),
  Actual_Revenue = summary(training_data$Revenue)[c(1,2,3,4,5,6)],
  Predicted_Revenue = summary(pred_illegal_lasso$predicted_revenue_lasso)[c(1,2,3,4,5,6)]
)

kable(summary_table, format = "html", caption = "Distribution Comparison: Actual vs Predicted Revenue") |>
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))
```

*This table summarizes the distribution of actual versus predicted revenue using key statistics (min, median, mean, and quartiles). The predicted values show a higher mean and larger upper tail, reflecting how several non-legal states exceed the revenue observed in legalized states.*

# Model Diagnostics {.tabset}

## LASSO Cross-Validation

```{r lasso-cv-plot}
plot(lasso_cv)
```

*This figure shows the LASSO model's cross-validation process. Each point represents the model's prediction error at a given penalty value (lambda). The selected λ minimizes mean-squared error, balancing model simplicity and predictive accuracy. The curve illustrates how adding too many predictors increases variance, while stronger penalization improves stability.*

## Actual vs Predicted

```{r actual-vs-predicted}
pred_lasso_train <- as.numeric(predict(lasso_model, newx = X_train))

training_data_lasso <- training_data %>%
  mutate(pred_lasso = pred_lasso_train)

ggplot(training_data_lasso, aes(x = Revenue, y = pred_lasso)) +
  geom_point(alpha = 0.7, color = "darkgreen", size = 3) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  scale_x_continuous(labels = scales::dollar) +
  scale_y_continuous(labels = scales::dollar) +
  labs(
    title = "Actual vs Predicted Revenue (LASSO)",
    x = "Actual Revenue",
    y = "Predicted Revenue"
  ) +
  theme_minimal(base_size = 13)
```

*This scatterplot compares predicted revenue to actual revenue in legalized states. The points generally follow an upward trend, indicating strong model performance.*

## Correlation Map

```{r correlation-map}
predictor_mat <- training_data %>%
  select(total_pop, median_income, pct_bachelors, pct_age_20_34,
         pct_urban, pct_poverty) %>%
  as.matrix()

corr_mat <- cor(predictor_mat)

corrplot(
  corr_mat,
  method = "color",
  type = "upper",
  col = viridis(200),
  tl.col = "black",
  tl.srt = 45,
  title = "Predictor Correlations",
  mar = c(0,0,1,0)
)
```

*This heatmap displays correlations among demographic predictors used in the modeling process. Strong correlations across income, education, population size, and poverty show multicollinearity.*

## Predictor Relationships

```{r predictor-relationships}
plot_df <- training_data %>%
  select(Revenue, total_pop, median_income, pct_bachelors,
         pct_age_20_34, pct_urban, pct_poverty) %>%
  pivot_longer(-Revenue, names_to = "predictor", values_to = "value")

ggplot(plot_df, aes(x = value, y = Revenue)) +
  geom_point(alpha = 0.7) +
  facet_wrap(~ predictor, scales = "free_x") +
  scale_y_continuous(labels = scales::dollar) +
  labs(
    title = "Revenue vs Key Demographic Predictors (Legal States)",
    # Set x to NULL so the facet titles serve as the x-axis labels
    x = NULL, 
    y = "Revenue"
  ) +
  theme_minimal(base_size = 13)
```

*These scatterplots show the relationship between individual demographic predictors and observed gambling revenue. While population and urbanization show clearer positive associations, other variables, such as poverty or median income, exhibit weak or inconsistent relationships. This reinforces the idea that gambling revenue is driven by a combination of demographic scale and specific high-engagement age groups rather than socioeconomic factors alone.*

## Feature Importance

```{r feature-importance}
coef_mat <- as.matrix(coef(lasso_cv, s = "lambda.min"))

coef_df <- tibble(
  variable = rownames(coef_mat),
  coefficient = coef_mat[, "lambda.min"]
) %>%
  filter(variable != "(Intercept)") %>%
  arrange(desc(abs(coefficient)))

ggplot(coef_df, aes(x = reorder(variable, abs(coefficient)), 
                    y = coefficient, 
                    fill = coefficient > 0)) +
  geom_col() +
  coord_flip() +
  scale_fill_manual(values = c("TRUE" = "#1b9e77", "FALSE" = "#d95f02"), guide = "none") +
  labs(
    title = "LASSO Coefficients at λ_min",
    subtitle = "Positive (Green) vs Negative (Orange) Impact",
    x = "",
    y = "Coefficient Estimate"
  ) +
  theme_minimal(base_size = 13)
```

## Model Performance

```{r model-performance}
# --- Linear Model Predictions ---
lm_pred <- predict(fit_lm)

# --- LASSO Predictions ---
lasso_pred <- as.numeric(predict(lasso_model, newx = X_train))

# --- True values ---
y_true <- training_data$Revenue

# --- Comparison Metrics ---
model_metrics <- tibble(
  Model = c("Linear Model", "LASSO Model"),
  RMSE  = c(rmse(y_true, lm_pred),
            rmse(y_true, lasso_pred)),
  MAE   = c(mae(y_true, lm_pred),
            mae(y_true, lasso_pred)),
  MAPE  = c(mape(y_true, lm_pred),
            mape(y_true, lasso_pred))
)

model_metrics %>%
  mutate(
    RMSE = scales::dollar(RMSE),
    MAE  = scales::dollar(MAE),
    MAPE = scales::percent(MAPE)
  ) %>%
  kable(format = "html", caption = "Model Performance Comparison: Linear Model vs LASSO") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))
```

*This table compares model performance metrics across the linear regression and LASSO model. LASSO performs similarly in RMSE but substantially better in MAPE, indicating higher stability for lower-revenue states. The comparison highlights the value of penalization when predictors show strong collinearity.*

# Conclusion

We compared a standard linear regression to a LASSO regularized model. Both models have sizeable error due to the extreme variability in state gambling revenues. While the linear model slightly outperforms LASSO in RMSE, the LASSO model achieves a much better MAPE (191% vs 344%), indicating more stable performance for low-revenue states.

LASSO also provides valuable model simplification: only two predictors retain nonzero coefficients—pct_age_20_34 and pct_urban, while income, population, poverty, and education are shrunk to zero. This suggests strong multicollinearity among socioeconomic indicators, with LASSO consolidating their predictive signal into a smaller set of variables. The results highlight that demographic structure (pct_age_20_34) and urbanization are the strongest predictors of sports gambling markets.