---
title: "Sports Betting Analysis"
output: 
  html_document:
    theme: flatly       
    highlight: pygments 
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE}
library(tidyverse)
library(rvest)
library(httr)
library(jsonlite)
library(patchwork)
library(glmnet)
library(webshot2)
library(scales)
library(corrplot)
library(Metrics)
library(kableExtra)
library(viridis)
library(plotly)

knitr::opts_chunk$set(
  fig.width = 8,
  fig.asp = .6,
  out.width = "90%",
  fig.align = "center",
  message = FALSE,
  warning = FALSE,
  echo = TRUE
)

# Increased base size for better readability of demographic plots
theme_set(theme_minimal(base_size = 15) + 
          theme(legend.position = "bottom",
                plot.title = element_text(face = "bold", hjust = 0.5),
                plot.subtitle = element_text(hjust = 0.5, color = "gray50")))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d
scientific_10 <- function(x) {
  parse(text=gsub("e", " %*% 10^", scales::scientific_format()(x)))
}
```

<style type="text/css">
/* General styling for website compatibility */
body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
h1, h2, h3 {
color: #2c3e50;
font-weight: 600;
}
.main-container {
max-width: 1500px;
margin-left: auto;
margin-right: auto;
}
</style>

```{r import-data, echo=FALSE}
total_state_revenue = read_csv("data/total_state_revenue.csv")
model_clean_2024 = read_csv("data/model_clean_2024.csv")
demographics_2024 = read_csv("data/demographics_2024.csv")

# Pre-calculate yearly revenue summary for the Revenue by Year plot
yearly_revenue_summary = total_state_revenue |> 
  group_by(Year) |> 
  summarize(Total_Revenue = sum(Revenue, na.rm = TRUE))

# Pre-calculate data for Growth by State plot
top_states = total_state_revenue |> 
  filter(Year == 2024) |> 
  slice_max(Revenue, n = 5) |> 
  pull(State)

state_growth_plot_data = total_state_revenue |> 
  mutate(
    State_Group = ifelse(State %in% top_states, State, "All Other")
  ) |> 
  group_by(Year, State_Group) |> 
  summarize(Revenue = sum(Revenue, na.rm = TRUE), .groups = "drop") |> 
  mutate(State_Group = fct_reorder(State_Group, Revenue, .desc = TRUE))
```

# Gambling Visuals {.tabset}

Below are several plots exploring the gambling revenue data. The first is a plot of total US gambling revenue between 2018-2024. Second is a plot of US gambling revenue across that time period among the top 5 ranked states in gambling revenue in 2024. Finally, the third plot depicts how the top 5 ranked states in gambling revenue shifted from 2018-2024.

## Revenue by Year

```{r revenue-by-year}
# Plotly bar chart showing total revenue by year
plot_ly(
  data = yearly_revenue_summary |> mutate(Year = as.factor(Year)),
  x = ~Year,
  y = ~Total_Revenue / 1e9,  # Convert to billions
  type = "bar", 
  color = ~Year,
  text = ~paste0("$", round(Total_Revenue / 1e9, 2), "B"),
  textposition = "outside",
  hovertemplate = paste0(
    "<b>Year:</b> %{x}<br>",
    "<b>Revenue:</b> $%{y:.2f}B<br>",
    "<extra></extra>"
  )
) |> 
  layout(
    title = "Total US Gambling Revenue (2018-2024)",
    xaxis = list(
      title = "Year"
    ),
    yaxis = list(
      title = "Total Revenue (US$)",
      tickprefix = "$",
      ticksuffix = "B"
    ),
    showlegend = FALSE,
    width = 900,
    height = 600
  )
```

## Growth by State

```{r growth-by-state-fixed}
# Plotly stacked bar chart showing revenue growth by state over time
state_growth_plot_data |> 
  mutate(Revenue_Billions = Revenue / 1e9) |> 
  plot_ly(
    x = ~Year,
    y = ~Revenue_Billions, 
    type = "bar", 
    color = ~State_Group,
    text = ~paste0("$", round(Revenue_Billions, 2), "B"),
    hovertemplate = paste0(
      "<b>State:</b> %{fullData.name}<br>",
      "<b>Year:</b> %{x}<br>",
      "<b>Revenue:</b> $%{y:.2f}B<br>",
      "<extra></extra>"
    )
  ) |> 
  layout(
    title = "US Gambling Revenue Growth by State",
    xaxis = list(
      title = "Year",
      tickvals = 2018:2024
    ),
    yaxis = list(
      title = "Revenue (US$)",
      tickprefix = "$",
      ticksuffix = "B"
    ),
    barmode = "stack",
    showlegend = TRUE,
    width = 900,
    height = 600
  )
```

## Market Rank Shifts

```{r market-rank-shifts}
# --- Data Processing ---
ranked_data = total_state_revenue |> 
  group_by(Year) |> 
  # Calculate rank, putting NAs last
  mutate(Rank = min_rank(desc(Revenue))) |> 
  ungroup()

# Identify "States of Interest" (Top 5 at any point)
focus_states = ranked_data |> 
  filter(Rank <= 5) |> 
  pull(State) |> 
  unique()

# Filter dataset
plot_data = ranked_data |> 
  filter(State %in% focus_states) |> 
  filter(!is.na(Rank)) |>  # Remove years where rank is NA (not legalized yet)
  arrange(Year) 

# --- Create Label Dataframes for Ends of Lines ---
# Left Side Labels (2018)
labels_start = plot_data |> 
  filter(Year == min(Year)) |> 
  mutate(label_text = paste0("#", Rank, " ", State))

# Right Side Labels (2024)
labels_end = plot_data |> 
  filter(Year == max(Year)) |> 
  mutate(label_text = paste0(State, " #", Rank))

# --- Build Plotly Object ---
plot_ly(data = plot_data) |> 
  
  # The Main Lines and Dots
  add_trace(
    x = ~Year, 
    y = ~Rank, 
    color = ~State,
    type = 'scatter', 
    mode = 'lines+markers',
    line = list(width = 3),
    marker = list(size = 5),
    # Custom Hover Text
    text = ~paste0("<b>", State, "</b><br>Year: ", Year, "<br>Rank: ", Rank, "<br>Revenue: $", round(Revenue/1e6, 1), "M"),
    hoverinfo = "text"
  ) |> 
  
  # Left Side Text Labels (Start of line)
  add_text(
    data = labels_start,
    x = ~Year, 
    y = ~Rank, 
    text = ~label_text,
    color = ~State,
    textposition = "middle left",
    hoverinfo = "skip",
    showlegend = FALSE
  ) |> 
  
  # Right Side Text Labels (End of line)
  add_text(
    data = labels_end,
    x = ~Year, 
    y = ~Rank, 
    text = ~label_text,
    color = ~State,
    textposition = "middle right",
    hoverinfo = "skip",
    showlegend = FALSE
  ) |> 
  
  # Layout Settings
  layout(
    title = list(text = "<b>Shift in Top Gambling Markets (2018-2024)</b>"),
    showlegend = FALSE, 
    xaxis = list(
      title = "",
      dtick = 1, 
      range = c(2018, 2024), 
      showgrid = FALSE
    ),
    yaxis = list(
      title = "Revenue Rank",
      autorange = "reversed", 
      zeroline = FALSE,
      showgrid = FALSE,
      tickmode = "array",
      tickvals = 1:max(plot_data$Rank, na.rm = TRUE) 
    ),
    margin = list(l = 100, r = 100),
    width = 900,
    height = 300
  )
```

# Demographic Visuals {.tabset}

Below are exploratory plots of the demographic data in 2024. The first plot shows the per capita revenue for each state. The second plot shows gambling revenue by state in 2024. The third plot compares the first two plots. The fourth plot shows the racial makeup in percentage of the total population in each state in 2024, arranged in descending order of total gambling revenue. The fifth plot depicts the percentage of the total population in poverty and unemployed in 2024 in each state, arranged in descending order of total gambling revenue.

## Population

```{r population-plot}
# Create data with Revenue Per Capita
rpc_plot_data = model_clean_2024 |>
  filter(State != "Washington D.C.") |>
  mutate(
    # Calculate the new metric
    revenue_per_capita = Revenue / total_pop,

    # Reorder State by Revenue Per Capita so the chart is sorted
    State = as.factor(State),
    State = fct_reorder(State, revenue_per_capita, .desc = FALSE)
  ) |>
  arrange(State)

# Extract the order for the axis
ordered_states_rpc = levels(rpc_plot_data$State)

rpc_plot = rpc_plot_data |>
  plot_ly(
    y = ~State,
    x = ~revenue_per_capita,
    type = "bar",
    # Changed color to a fixed value for all bars
    marker = list(color = "steelblue"),
    # Format text as currency
    text = ~paste0("$", round(revenue_per_capita, 2)),
    textposition = "outside",
    hovertemplate = paste0(
      "<b>State:</b> %{y}<br>",
      "<b>Rev/Capita:</b> %{text}<br>",
      "<extra></extra>"
    )
  ) |>
  layout(
    title = "Gambling Revenue Per Capita by State (2024)",
    yaxis = list(
      title = "", # Removed title for cleaner look in wide format
      tickangle = 0,
      tickmode = "array",
      tickvals = ordered_states_rpc,
      ticktext = ordered_states_rpc
    ),
    xaxis = list(
      title = "Revenue Per Capita ($)",
      tickprefix = "$"
    ),
    showlegend = FALSE,
    width = 700,
    height = 500 # Increased height slightly to fit all states clearly
  )

rpc_plot
```

*This bar chart displays the total population of each state where gambling is legal, sorted by descending 2024 gambling revenue. Larger states like New York, Pennsylvania, and Illinois occupy the top positions, reflecting their large population bases. However, population size alone doesn't determine revenue rank—smaller states like Nevada punch above their weight due to tourism and established gambling infrastructure.*

## Revenue

```{r revenue-plot}
revenue_plot_data <- model_clean_2024 %>%
  filter(State != "Washington D.C.") %>%
  mutate(
    State = as.factor(State),
    State = fct_reorder(State, Revenue) 
  ) %>%
  arrange(State)

# Create Plot
revenue_plot <- revenue_plot_data %>%
  mutate(revenue_millions = Revenue / 1e6) %>%
  plot_ly(
    y = ~State,                 
    x = ~revenue_millions,      
    type = "bar", 
    orientation = 'h',          
    marker = list(color = "steelblue"), 
    text = ~paste0("$", round(revenue_millions, 1), "M"),
    textposition = "outside",
    hovertemplate = paste0(
      "<b>State:</b> %{y}<br>",
      "<b>Revenue:</b> $%{x:.1f}M<br>",
      "<extra></extra>"
    )
  ) %>%
  layout(
    title = "Gambling Revenue by State (2024)",
    yaxis = list(
      title = "",           
      tickvals = levels(revenue_plot_data$State),    
      ticktext = levels(revenue_plot_data$State),
      automargin = TRUE     
    ),
    xaxis = list(
      title = "Revenue (Millions $)",
      tickprefix = "$",
      ticksuffix = "M"
    ),
    showlegend = FALSE,
    width = 900,
    height = 600,
    margin = list(l = 10, r = 50) 
  )

revenue_plot
```

*This bar chart shows gambling revenue by state in 2024, arranged in descending order. New York leads significantly, followed by Pennsylvania, Illinois, and Nevada. The chart demonstrates the concentration of gambling revenue among a few large states, with a steep drop-off after the top performers. This pattern reflects both population size and market maturity.*

## Comparison

```{r combined-plots}
combined_revenue_population = 
  subplot(
    rpc_plot,       
    revenue_plot, 
    nrows = 2,        
    shareX = FALSE,  
    titleY = TRUE,
    titleX = TRUE,
    margin = 0.05    
  ) |> 
  layout(
    title = "Per Capita vs Total Revenue Comparison",
    showlegend = FALSE,
    width = 900,
    height = 800    
  )

combined_revenue_population
```

*This combined visualization places population and revenue side-by-side for direct comparison. The alignment reveals that while population is a strong driver of gambling revenue, the relationship isn't perfectly linear. States with similar populations can have vastly different revenue outcomes, highlighting the influence of other factors like urbanization, regulatory environment, and gambling culture.*

## Racial Makeup

```{r racial-makeup}
race_plot_data = model_clean_2024 |> 
  filter(State != "Washington D.C.") |> 
  select(State, Revenue, pct_white, pct_black, pct_asian, pct_hispanic) |> 
  pivot_longer(
    cols = pct_white:pct_hispanic,
    names_to = "race",
    values_to = "percentage"
  ) |> 
  mutate(
    State = as.factor(State),
    State = fct_reorder(State, Revenue), 
    race = factor(race, 
                  levels = c("pct_white", "pct_black", "pct_asian", "pct_hispanic"),
                  labels = c("White", "Black", "Asian", "Hispanic"))
  ) |> 
  arrange(State)

ordered_states_race = levels(race_plot_data$State)

race_plot_data |> 
  plot_ly(
    y = ~State,              
    x = ~percentage * 100,    
    color = ~race,
    type = 'bar',
    orientation = 'h',     
    hovertemplate = paste0(
      "<b>State:</b> %{y}<br>",
      "<b>Race:</b> %{fullData.name}<br>",
      "<b>Percentage:</b> %{x:.1f}%<br>",
      "<extra></extra>"
    )
  ) |> 
  layout(
    title = "Racial Makeup by State (Sorted by Revenue)",      
    yaxis = list(
      title = "",         
      tickmode = "array",
      tickvals = ordered_states_race,
      ticktext = ordered_states_race,
      automargin = TRUE
    ),
    xaxis = list(
      title = "Percentage of Population", 
      ticksuffix = "%",
      range = c(0, 100)
    ),
    barmode = "stack",
    showlegend = TRUE,
    legend = list(orientation = "h", y = -0.05, x = 0.5, xanchor = "center"), 
    width = 900,
    height = 800, 
    margin = list(l = 10, r = 20, b = 50, t = 50)
  )
```

*This stacked bar chart shows the racial composition of each state's population, ordered by descending gambling revenue. Each bar represents 100% of a state's population, divided by racial/ethnic group. The chart reveals relatively consistent demographic patterns across states, with White populations forming the majority in most markets. States with higher gambling revenue don't show a clear racial pattern, suggesting that race alone is not a primary driver of market size—instead, population scale and urbanization appear more influential.*

## Economic Stats

```{r economic-stats}
economic_plot_data = model_clean_2024 |> 
  filter(State != "Washington D.C.") |> 
  select(State, Revenue, unemployment_rate, pct_poverty) |> 
  pivot_longer(
    cols = c("pct_poverty", "unemployment_rate"),
    names_to = "measure",
    values_to = "percentage"
  ) |> 
  mutate(
    State = as.factor(State),
    State = fct_reorder(State, Revenue), 
    measure = factor(measure, 
                     levels = c("pct_poverty", "unemployment_rate"),
                     labels = c("% in Poverty", "% Unemployed"))
  ) |> 
  arrange(State)

ordered_states_econ = levels(economic_plot_data$State)

economic_plot_data |> 
  plot_ly(
    y = ~State,                
    x = ~percentage * 100,    
    color = ~measure,
    type = 'scatter',
    mode = 'lines+markers',
    orientation = 'h',         
    text = ~paste(State, ": ", sprintf("%.1f%%", percentage * 100)),
    hoverinfo = 'text',
    line = list(width = 2)
  ) |> 
  layout(
    title = "Poverty & Unemployment (Sorted by Revenue)",      
    yaxis = list(
      title = "",              # Clean look
      tickmode = "array",
      tickvals = ordered_states_econ,
      ticktext = ordered_states_econ,
      automargin = TRUE
    ),
    xaxis = list(
      title = "Percentage of Population", 
      ticksuffix = "%"
    ),
    showlegend = TRUE,
    legend = list(orientation = "h", y = -0.05, x = 0.5, xanchor = "center"),
    width = 900,
    height = 800, 
    margin = list(l = 10, r = 20, b = 50, t = 50)
  )
```

*This line plot tracks poverty and unemployment rates across states, ordered by gambling revenue. Both metrics fluctuate around similar ranges (roughly 3-6% unemployment, 8-15% poverty), with no clear correlation to revenue rank. High-revenue states like Nevada and New Jersey don't show consistently lower poverty or unemployment, while some lower-revenue states have favorable economic indicators. This suggests that economic hardship measures are not strong predictors of gambling market size.*

# Predictive Modeling

## Model Setup

We begin by building our training dataset, fitting a standard linear model for comparison, and handling missing values.

```{r model-setup}
# Build training dataset
training_data <- model_clean_2024 |>
  select(
    State, Revenue, total_pop, median_income, 
    pct_bachelors, pct_age_20_34, pct_urban, pct_poverty
  ) |>
  drop_na()

# Fit Linear Model for later comparison
fit_lm <- lm(
  Revenue ~ total_pop + median_income + pct_bachelors +
    pct_age_20_34 + pct_urban + pct_poverty,
  data = training_data
)

# Prepare Illegal States Data
states_no_gambling <- demographics_2024 |>
  anti_join(training_data, by = "State")

newdata_illegal <- states_no_gambling |>
  select(
    State, total_pop, median_income, pct_bachelors, 
    pct_age_20_34, pct_urban, pct_poverty
  ) |>
  drop_na()
```

## LASSO Regression

We implement a LASSO regression to handle multicollinearity and perform feature selection.

```{r lasso-regression}
# Build design matrix
X_train <- model.matrix(
  Revenue ~ total_pop + median_income + pct_bachelors +
    pct_age_20_34 + pct_urban + pct_poverty,
  data = training_data)[, -1]

y_train <- training_data$Revenue

set.seed(123)

# Cross-validated LASSO
lasso_cv <- cv.glmnet(X_train, y_train, alpha = 1, nfolds = 5, standardize = TRUE)
lasso_model <- glmnet(X_train, y_train, alpha = 1, lambda = lasso_cv$lambda.min, standardize = TRUE)

# Predictions for non-gambling states
X_new <- model.matrix(
  ~ total_pop + median_income + pct_bachelors +
    pct_age_20_34 + pct_urban + pct_poverty,
  data = newdata_illegal)[, -1]

pred_illegal_lasso <- newdata_illegal |>
  mutate(
    predicted_revenue_lasso = as.numeric(predict(lasso_model, newx = X_new)),
    predicted_revenue_lasso = pmax(predicted_revenue_lasso, 0) # Remove negative predictions
  ) |>
  arrange(desc(predicted_revenue_lasso))
```

## Prediction Results

LASSO regression predictions per state.

```{r prediction-results}
pred_table <- pred_illegal_lasso |>
  mutate(
    Predicted_Revenue = scales::dollar(predicted_revenue_lasso),
    Population = scales::comma(total_pop),
    Median_Income = scales::dollar(median_income)
  ) |>
  select(
    State, Population, Median_Income, pct_bachelors, 
    pct_age_20_34, pct_urban, pct_poverty, Predicted_Revenue
  )

kable(pred_table, format = "html") |>
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed"))
```

*This table presents the predicted gambling revenue for each state that has not yet legalized sports betting. Using the LASSO model, we estimated annual revenue based on demographic characteristics, including population size, educational attainment, urbanization, and poverty rates. The table shows that states like California, Texas, and Florida have demographic profiles similar to those of current high-revenue states, suggesting substantial untapped market potential if legalization were pursued.*

## Visualizing Predictions

```{r visualizing-predictions}
pred_illegal_lasso_plot <- pred_illegal_lasso |>
  mutate(State = factor(State, levels = State)) # Maintain sorted order

ggplot(pred_illegal_lasso_plot, aes(x = State, y = predicted_revenue_lasso / 1e6)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  scale_y_continuous(labels = function(x) paste0("$", x, "M")) +
  labs(
    title = "Predicted Annual Gambling Revenue (if legalized)",
    subtitle = "LASSO model predictions for states without legal sports gambling",
    x = "",
    y = "Predicted Revenue (Millions $)"
  ) +
  theme_minimal(base_size = 13)
```

*This bar chart visualizes predicted gambling revenue for each non-legal state, ranked from highest to lowest. Large states with urban populations and strong young-adult demographics (such as California, Texas, and Florida) show the highest predicted revenue, reinforcing the idea that demographic scale influences potential market size. Smaller or more rural states are projected to generate minimal revenue.*

## Distribution of Predictions

```{r distribution-predictions}
compare_df <- tibble(
  group = c(rep("Actual Revenue (Legal States)", nrow(training_data)),
            rep("Predicted Revenue (Non-Legal States)", nrow(pred_illegal_lasso))),
  revenue = c(training_data$Revenue,
              pred_illegal_lasso$predicted_revenue_lasso)
)

ggplot(compare_df, aes(x = revenue / 1e6, fill = group)) +
  geom_density(alpha = 0.4) +
  scale_x_continuous(labels = function(x) paste0("$", x, "M")) +
  labs(
    title = "Distribution of Actual vs Predicted Gambling Revenue",
    x = "Revenue (Millions US$)",
    y = "Density",
    fill = ""
  ) +
  theme_minimal(base_size = 13)
```

*This density plot compares the distribution of observed gambling revenue in legalized states with the predicted revenue for non-legal states. The predicted values span a wider range, with some states projecting higher revenue than current legal markets. This suggests that expansion into a few large states could dramatically reshape the national gambling landscape.*

## Population vs Revenue Comparison

```{r population-revenue-comparison}
scatter_df <- bind_rows(
  training_data |> mutate(type = "Actual Revenue"),
  pred_illegal_lasso |> 
    mutate(Revenue = predicted_revenue_lasso,
           type = "Predicted Revenue")
)

ggplot(scatter_df, aes(x = total_pop / 1e6, y = Revenue / 1e6, color = type)) +
  geom_point(size = 3, alpha = 0.7) +
  scale_x_continuous(labels = function(x) paste0(x, "M")) +
  scale_y_continuous(labels = function(x) paste0("$", x, "M")) +
  labs(
    title = "Population vs Gambling Revenue",
    subtitle = "Comparing actual and predicted states",
    x = "Total Population (Millions)",
    y = "Revenue (Millions $)",
    color = ""
  ) +
  theme_minimal(base_size = 13)
```

*Here we compare how population relates to revenue in both actual and predicted markets. Larger states show higher revenue but the plot also shows that population alone does not fully explain gambling revenue.*

## Distribution Statistics

```{r distribution-statistics}
summary_table <- tibble(
  Metric = c("Min", "1st Quartile", "Median", "Mean", "3rd Quartile", "Max"),
  Actual_Revenue = summary(training_data$Revenue)[c(1,2,3,4,5,6)],
  Predicted_Revenue = summary(pred_illegal_lasso$predicted_revenue_lasso)[c(1,2,3,4,5,6)]
)

kable(summary_table, format = "html", caption = "Distribution Comparison: Actual vs Predicted Revenue") |>
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))
```

*This table summarizes the distribution of actual versus predicted revenue using key statistics (min, median, mean, and quartiles). The predicted values show a higher mean and larger upper tail, reflecting how several non-legal states exceed the revenue observed in legalized states.*

# Model Diagnostics {.tabset}

## LASSO Cross-Validation

```{r lasso-cv-plot}
# Extract the data from the lasso_cv object
cv_data <- tibble(
  lambda = lasso_cv$lambda,
  mse    = lasso_cv$cvm,   # Mean Squared Error
  cvup   = lasso_cv$cvup,  # Upper error bound
  cvlo   = lasso_cv$cvlo   # Lower error bound
)

# Plot using ggplot2 
ggplot(cv_data, aes(x = -log(lambda), y = mse)) +
  # Add the error bars (grey vertical lines)
  geom_errorbar(aes(ymin = cvlo, ymax = cvup), color = "gray", width = 0.05) +
  # Add the red dots
  geom_point(color = "red", size = 1.5) +
  # Add the vertical dotted lines for lambda.min and lambda.1se
  geom_vline(xintercept = -log(lasso_cv$lambda.min), linetype = "dotted") +
  geom_vline(xintercept = -log(lasso_cv$lambda.1se), linetype = "dotted") +
  # Labels and Theme
  labs(
    title = "LASSO Cross-Validation",
    x = "-Log(Lambda)",
    y = "Mean-Squared Error"
  ) +
  theme_minimal(base_size = 13)
```

*This figure shows the LASSO model's cross-validation process. Each point represents the model's prediction error at a given penalty value (lambda). The selected λ minimizes mean-squared error, balancing model simplicity and predictive accuracy. The curve illustrates how adding too many predictors increases variance, while stronger penalization improves stability.*

## Actual vs Predicted

```{r actual-vs-predicted}
pred_lasso_train <- as.numeric(predict(lasso_model, newx = X_train))

training_data_lasso <- training_data %>%
  mutate(pred_lasso = pred_lasso_train)

ggplot(training_data_lasso, aes(x = Revenue / 1e6, y = pred_lasso / 1e6)) +
  geom_point(alpha = 0.7, color = "darkgreen", size = 3) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  scale_x_continuous(labels = function(x) paste0("$", x, "M")) +
  scale_y_continuous(labels = function(x) paste0("$", x, "M")) +
  labs(
    title = "Actual vs Predicted Revenue (LASSO)",
    x = "Actual Revenue (Millions $)",
    y = "Predicted Revenue (Millions $)"
  ) +
  theme_minimal(base_size = 13)
```

*This scatterplot compares predicted revenue to actual revenue in legalized states. The points generally follow an upward trend, indicating strong model performance.*

## Correlation Map

```{r correlation-map}
predictor_mat <- training_data %>%
  select(total_pop, median_income, pct_bachelors, pct_age_20_34,
         pct_urban, pct_poverty) %>%
  as.matrix()

corr_mat <- cor(predictor_mat)

corrplot(
  corr_mat,
  method = "color",
  type = "upper",
  col = viridis(200),
  tl.col = "black",
  tl.srt = 45,
  title = "Predictor Correlations",
  mar = c(0,0,1,0)
)
```

*This heatmap displays correlations among demographic predictors used in the modeling process. Strong correlations across income, education, population size, and poverty show multicollinearity.*

## Predictor Relationships

```{r predictor-relationships}
plot_df <- training_data %>%
  select(Revenue, total_pop, median_income, pct_bachelors,
         pct_age_20_34, pct_urban, pct_poverty) %>%
  pivot_longer(-Revenue, names_to = "predictor", values_to = "value")

ggplot(plot_df, aes(x = value, y = Revenue / 1e6)) +
  geom_point(alpha = 0.7) +
  facet_wrap(~ predictor, scales = "free_x") +
  scale_y_continuous(labels = function(x) paste0("$", x, "M")) +
  labs(
    title = "Revenue vs Key Demographic Predictors (Legal States)",
    x = NULL, 
    y = "Revenue (Millions $)"
  ) +
  theme_minimal(base_size = 13)
```

*These scatterplots show the relationship between individual demographic predictors and observed gambling revenue. While population and urbanization show clearer positive associations, other variables, such as poverty or median income, exhibit weak or inconsistent relationships. This reinforces the idea that gambling revenue is driven by a combination of demographic scale and specific high-engagement age groups rather than socioeconomic factors alone.*

## Model Performance

```{r model-performance}
# --- Linear Model Predictions ---
lm_pred <- predict(fit_lm)

# --- LASSO Predictions ---
lasso_pred <- as.numeric(predict(lasso_model, newx = X_train))

# --- True values ---
y_true <- training_data$Revenue

# --- Comparison Metrics ---
model_metrics <- tibble(
  Model = c("Linear Model", "LASSO Model"),
  RMSE  = c(rmse(y_true, lm_pred),
            rmse(y_true, lasso_pred)),
  MAE   = c(mae(y_true, lm_pred),
            mae(y_true, lasso_pred)),
  MAPE  = c(mape(y_true, lm_pred),
            mape(y_true, lasso_pred))
)

model_metrics %>%
  mutate(
    RMSE = scales::dollar(RMSE),
    MAE  = scales::dollar(MAE),
    MAPE = scales::percent(MAPE)
  ) %>%
  kable(format = "html", caption = "Model Performance Comparison: Linear Model vs LASSO") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))
```

*This table compares model performance metrics across the linear regression and LASSO model. LASSO performs similarly in RMSE but substantially better in MAPE, indicating higher stability for lower-revenue states. The comparison highlights the value of penalization when predictors show strong collinearity.*

# Conclusion

We compared a standard linear regression to a LASSO regularized model. Both models have sizeable error due to the extreme variability in state gambling revenues. While the linear model slightly outperforms LASSO in RMSE, the LASSO model achieves a much better MAPE (191% vs 344%), indicating more stable performance for low-revenue states.

LASSO also provides valuable model simplification: only two predictors retain nonzero coefficients—pct_age_20_34 and pct_urban, while income, population, poverty, and education are shrunk to zero. This suggests strong multicollinearity among socioeconomic indicators, with LASSO consolidating their predictive signal into a smaller set of variables. The results highlight that demographic structure (pct_age_20_34) and urbanization are the strongest predictors of sports gambling markets.
