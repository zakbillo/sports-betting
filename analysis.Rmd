---
title: 'Analysis'
---

```{r packages}
library(tidyverse)
library(rvest)
library(httr)
library(jsonlite)
library(patchwork)
library(glmnet)
library(webshot2)
library(scales)
library(corrplot)
library(Metrics)
library(kableExtra)
library(viridis)

knitr::opts_chunk$set(
fig.width = 6,
fig.asp = .6,
out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
ggplot2.continuous.colour = "viridis",
ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

### Exploratory Data Analysis

Import Data

```{r, message = FALSE}
total_state_revenue = read_csv("data/total_state_revenue.csv")
model_clean_2024 = read_csv("data/model_clean_2024.csv")
demographics_2024 = read_csv("data/demographics_2024.csv")
```

## Gambling visuals

Plot gambling revenue by year

```{r Plotting gambling revenue by Year}
# Aggregate total revenue by year
yearly_revenue_summary = total_state_revenue |> 
  group_by(Year) |> 
  summarize(Total_Revenue = sum(Revenue, na.rm = TRUE))

yearly_revenue_summary |> 
  ggplot(aes(x = Year, y = Total_Revenue)) +
  geom_col(aes(fill = as.factor(Year)), show.legend = FALSE) +
  geom_text(aes(label = scales::dollar(Total_Revenue, scale = 1e-9, suffix = "B")), 
            vjust = -0.5) + # Add labels in Billions
  scale_y_continuous(labels = scales::dollar_format()) +
  scale_x_continuous(breaks = 2018:2024) +
  labs(
    title = "Total US Gambling Revenue (2018-2024)",
    subtitle = "Aggregated revenue across all states",
    x = "Year",
    y = "Total Revenue"
  )
```
 
Plotting gambling revenue by state over time

```{r Plotting gambling revenue by State Over time}
# Identify top 5 states by 2024 revenue to keep things looking clean
top_states = total_state_revenue |> 
  filter(Year == 2019) |> 
  slice_max(Revenue, n = 5) |> 
  pull(State)

state_growth_plot_data = total_state_revenue |> 
  mutate(
    State_Group = ifelse(State %in% top_states, State, "All Other")
  ) |> 
  group_by(Year, State_Group) |> 
  summarize(Revenue = sum(Revenue, na.rm = TRUE), .groups = "drop") |> 
  mutate(State_Group = fct_reorder(State_Group, Revenue, .desc = TRUE))


ggplot(state_growth_plot_data, aes(x = Year, y = Revenue, fill = State_Group)) +
  geom_col() +
  scale_y_continuous(labels = scales::dollar_format()) +
  scale_x_continuous(breaks = 2018:2024) +
  labs(
    title = "US Gambling Revenue Growth by State",
    x = "Year",
    y = "Revenue",
    fill = "State"
  )
```

Plotting revenue rank: top 5 gambling markets by year since 2018

```{r plotting revenue rank: top 5 gambling markets by year since 2018}
# Calculate Ranks for every state, every year
ranked_data = total_state_revenue |> 
  group_by(Year) |> 
  mutate(Rank = min_rank(desc(Revenue))) |> 
  ungroup()

# Identify "States of Interest"
# We want to track any state that was Top 5 at any point
focus_states = ranked_data |> 
  filter(Rank <= 5) |>  # can change if we want less point to start and end points: filter((Year == 2018 & Rank <= 5) | (Year == 2024 & Rank <= 5)) |>
  pull(State) |> 
  unique()

# Filter the dataset to just those states
plot_data = ranked_data |> 
  filter(State %in% focus_states)

plot_data |> 
  ggplot(aes(x = Year, y = Rank, color = State, group = State)) +
  geom_point(size = 3) +
  geom_line(linewidth = 1.2) + 
  scale_y_reverse(breaks = 1:max(plot_data$Rank, na.rm = TRUE)) + 
  scale_x_continuous(breaks = 2018:2024) +
  geom_text(data = plot_data |> filter(Year == 2018), 
            aes(label = paste(Rank, State)), x = 2017.8, hjust = 1, size = 3) +
  geom_text(data = plot_data |> filter(Year == 2024), 
            aes(label = paste(Rank, State)), x = 2024.2, hjust = 0, size = 3) +
  labs(
    title = "Shift in Top Gambling Markets (2018 vs 2024)",
    subtitle = "Tracking the rank of states that were in the top 5 in either 2018 or 2024",
    y = "Revenue Rank",
    x = "Year"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",        
    panel.grid.minor = element_blank()
  ) +
  coord_cartesian(xlim = c(2017, 2025))
```

## Demographic visuals

Plot of Total Population in 2024 by State

```{r}
population_plot = 
  model_clean_2024 |> 
    filter(State != "Washington D.C.") |> #drop DC bc all demographic data is NA
    mutate(
      State = as.factor(State),
      State = fct_reorder(State, total_pop, .desc = TRUE)
    ) |> 
    ggplot(aes(x = State, y = total_pop)) +
    geom_col(aes(fill = State)) +
    theme(
      axis.text.x = element_text(angle = 90, hjust = 1, vjust = 1),
      legend.position = "none") +
    labs(
        y = "Total Population",
        title = "Total Population by State in 2024"
      )
```

Plot of Gambling Revenue in 2024 by State

```{r}
revenue_plot = 
  model_clean_2024 |> 
    filter(State != "Washington D.C.") |> #drop DC bc all demographic data is NA
    mutate(
      State = as.factor(State),
      State = fct_reorder(State, total_pop, .desc = TRUE)
    ) |> 
    ggplot(aes(x = State, y = Revenue)) +
    geom_col(aes(fill = State)) +
    theme(
      axis.text.x = element_text(angle = 90, hjust = 1, vjust = 1),
      legend.position = "none") +
    labs(
        x = "State (in order of largest to smallest total population)",
        y = "Revenue",
        title = "Gambling Revenue by State in 2024"
      )
```

Patchwork Plot of Total Population and Gambling Revenue in 2024 by State

```{r, fig.width = 10}
combined_revenue_population = (population_plot + revenue_plot)

combined_revenue_population
```

Racial Makeup of States in 2024

```{r}
model_clean_2024 |> 
  filter(State != "Washington D.C.") |> #drop DC bc all demographic data is NA
  select(State, Revenue, pct_white, pct_black, pct_asian, pct_hispanic) |> 
  pivot_longer(
    cols = pct_white:pct_hispanic,
    names_to = "race",
    values_to = "percentage"
  ) |> 
  mutate(
      State = as.factor(State),
      State = fct_reorder(State, Revenue, .desc = TRUE),
      race = factor(race,
                  levels = c("pct_white", "pct_black", "pct_asian", "pct_hispanic"),
                  labels = c("% White", "% Black", "% Asian", "% Hispanic"))
  ) |> 
  ggplot(aes(x = State, y = percentage, color = race, group = race)) +
  geom_point() +
  geom_line() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 1)) +
    labs(
        x = "State (in order of largest to smallest gambling revenue)",
        y = "Percentage of Population",
        title = "Racial Makeup by State in 2024",
        fill = "Race"
    ) 
```

Poverty % and Unemployment Rate by State in 2024

```{r}
model_clean_2024 |> 
  filter(State != "Washington D.C.") |> #drop DC bc all demographic data is NA
  select(State, Revenue, unemployment_rate, pct_poverty) |> 
  pivot_longer(
    cols = c("pct_poverty", "unemployment_rate"),
    names_to = "measure",
    values_to = "percentage"
  ) |> 
  mutate(
      State = as.factor(State),
      State = fct_reorder(State, Revenue, .desc = TRUE),
      measure = factor(measure,
                  levels = c("pct_poverty", "unemployment_rate"),
                  labels = c("% in Poverty", "% Unemployed"))
  ) |> 
  ggplot(aes(x = State, y = percentage, color = measure, group = measure)) +
  geom_point() +
  geom_line() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 1)) +
    labs(
        x = "State (in order of largest to smallest gambling revenue)",
        y = "Percentage of Population",
        title = "% Poverty and Unemployment Rate by State in 2024",
        fill = "Measure"
    ) 
```

### Let's build a predictive model!

Build training dataset 

```{r}
# Build training dataset
training_data <- model_clean_2024 |>
  select(
    State,
    Revenue,
    total_pop,
    median_income,
    pct_bachelors,
    pct_age_20_34,
    pct_urban,
    pct_poverty
  ) |>
  drop_na()   # make sure no missing values in predictors or Revenue
```

Fit linear regression model

```{r}
# Fit linear regression model

# Model: Revenue = β0 + β1 * total_pop + β2 * median_income + ... + error
fit_lm <- lm(
  Revenue ~ total_pop + median_income + pct_bachelors +
    pct_age_20_34 + pct_urban + pct_poverty,
  data = training_data
  )

summary(fit_lm)
```

```{r}
states_no_gambling <-
  demographics_2024 |>
  anti_join(training_data, by = "State")

newdata_illegal <-
  states_no_gambling |>
  select(
    State,
    total_pop,
    median_income,
    pct_bachelors,
    pct_age_20_34,
    pct_urban,
    pct_poverty
  ) |>
  drop_na()  # just in case a state is missing some demographic
```

Predict revenue if illegal states legalized gambling

```{r}
# Predict revenue if these states legalized gambling

pred_illegal <-
  newdata_illegal |>
  mutate(
    predicted_revenue = predict(fit_lm, newdata = newdata_illegal)
  ) |>
  arrange(desc(predicted_revenue))
```

Compare distribution of real vs predicted

```{r}
# Compare distribution of real vs predicted
summary(training_data$Revenue)
summary(pred_illegal$predicted_revenue)
```

Fit a LASSO regression model

```{r}
# Fit LASSO regression model

# Build design matrix (same predictors as your LM model)
X_train <- model.matrix(
  Revenue ~ total_pop + median_income + pct_bachelors +
    pct_age_20_34 + pct_urban + pct_poverty,
  data = training_data)[, -1]   # remove intercept column (glmnet adds its own)

# Outcome vector
y_train <- training_data$Revenue

set.seed(123)

# Cross-validated LASSO to choose lambda
lasso_cv <- cv.glmnet(
  X_train,
  y_train,
  alpha = 1,          # LASSO penalty
  nfolds = 5,
  standardize = TRUE  # recommended because predictors differ in scale
)

# Final LASSO model at best lambda
lasso_model <- glmnet(
  X_train,
  y_train,
  alpha = 1,
  lambda = lasso_cv$lambda.min,
  standardize = TRUE
)

lasso_cv$lambda.min #This is the penalty 
```

Build the prediction matrix for the non-gambling states

```{r Predictive model}
# Build the prediction matrix for the non-gambling states
X_new <- model.matrix(
  ~ total_pop + median_income + pct_bachelors +
    pct_age_20_34 + pct_urban + pct_poverty,
  data = newdata_illegal)[, -1]   # remove intercept column

# LASSO predictions
pred_illegal_lasso <-
  newdata_illegal |>
  mutate(
    predicted_revenue_lasso = as.numeric(
      predict(lasso_model, newx = X_new)
    )
  ) |>
  arrange(desc(predicted_revenue_lasso))

pred_illegal_lasso <- pred_illegal_lasso |> 
  mutate(predicted_revenue_lasso = pmax(predicted_revenue_lasso, 0))
```

Compare models 

```{r Compare models}
summary(training_data$Revenue)
summary(pred_illegal$predicted_revenue)          # from LM model
summary(pred_illegal_lasso$predicted_revenue_lasso)  # from LASSO model

#LASSO better
```

## Predictive model tables and Figures

Table of Predicted Annual Gambling Revenue for Non-Legal States (LASSO Model)

```{r Tables}
# Clean negative values
pred_illegal_lasso <- pred_illegal_lasso |>
  mutate(predicted_revenue_lasso = pmax(predicted_revenue_lasso, 0))

# Clean and format final table
pred_table <- pred_illegal_lasso |>
  mutate(
    Predicted_Revenue = dollar(predicted_revenue_lasso),
    Population = comma(total_pop),
    Median_Income = dollar(median_income)
  ) |>
  select(
    State,
    Population,
    Median_Income,
    pct_bachelors,
    pct_age_20_34,
    pct_urban,
    pct_poverty,
    Predicted_Revenue
  )

kable(pred_table, format = "html", caption = "Predicted Annual Gambling Revenue for Non-Legal States (LASSO Model)") |>
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))
```

Bar plot of predicted annual gambling revenue (if legalized)

```{r Bar Plot}
pred_illegal_lasso_plot <- pred_illegal_lasso |>
  mutate(predicted_revenue_lasso = pmax(predicted_revenue_lasso, 0)) |>
  arrange(predicted_revenue_lasso) |>
  mutate(State = factor(State, levels = State))

ggplot(pred_illegal_lasso_plot, aes(x = State, y = predicted_revenue_lasso)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  scale_y_continuous(labels = dollar) +
  labs(
    title = "Predicted Annual Gambling Revenue (if legalized)",
    subtitle = "LASSO model predictions for states without legal sports gambling",
    x = "",
    y = "Predicted Revenue"
  ) +
  theme_minimal(base_size = 13)
```

Density plot of distribution of actual vs predicted gambling revenue

```{r}
compare_df <- tibble(
  group = c(rep("Actual Revenue (Legal States)", nrow(training_data)),
            rep("Predicted Revenue (Non-Legal States)", nrow(pred_illegal_lasso))),
  revenue = c(training_data$Revenue,
              pred_illegal_lasso$predicted_revenue_lasso)
)

ggplot(compare_df, aes(x = revenue, fill = group)) +
  geom_density(alpha = 0.4) +
  scale_x_continuous(labels = dollar) +
  labs(
    title = "Distribution of Actual vs Predicted Gambling Revenue",
    x = "Revenue",
    y = "Density",
    fill = ""
  ) +
  theme_minimal(base_size = 13)
```

Scatterplot of population vs gambling revenue comparing actual and predicted states

```{r}
scatter_df <- bind_rows(
  training_data |> mutate(type = "Actual Revenue"),
  pred_illegal_lasso |> 
    mutate(Revenue = predicted_revenue_lasso,
           type = "Predicted Revenue")
)

ggplot(scatter_df, aes(x = total_pop, y = Revenue, color = type)) +
  geom_point(size = 3, alpha = 0.7) +
  scale_x_continuous(labels = comma) +
  scale_y_continuous(labels = dollar) +
  labs(
    title = "Population vs Gambling Revenue",
    subtitle = "Comparing actual and predicted states",
    x = "Total Population",
    y = "Revenue",
    color = ""
  ) +
  theme_minimal(base_size = 13)
```

Table of distribution comparison of actual vs. predicted revenue

```{r}
summary_table <- tibble(
  Metric = c("Min", "1st Quartile", "Median", "Mean", "3rd Quartile", "Max"),
  Actual_Revenue = summary(training_data$Revenue)[c(1,2,3,4,5,6)],
  Predicted_Revenue = summary(pred_illegal_lasso$predicted_revenue_lasso)[c(1,2,3,4,5,6)]
)

kable(summary_table, format = "html", caption = "Distribution Comparison: Actual vs Predicted Revenue") |>
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))
```

```{r}
# Prepare actual revenue table
actual_table <- training_data %>%
  select(State, Revenue) %>%
  mutate(
    revenue_source = "Actual (Legal States)",
    Revenue = as.numeric(Revenue)
  )

# Prepare predicted revenue table (LASSO)
predicted_table <- pred_illegal_lasso %>%
  select(State, predicted_revenue_lasso) %>%
  rename(Revenue = predicted_revenue_lasso) %>%
  mutate(
    revenue_source = "Predicted (Non-Legal States)"
  )

# Combine both tables
ranked_table <- bind_rows(actual_table, predicted_table) %>%
  arrange(desc(Revenue)) %>%
  mutate(
    Rank = row_number(),
    Revenue = scales::dollar(Revenue)
  ) %>%
  select(Rank, State, Revenue, revenue_source)
```

LASSO cross-validation plot (lamda vs. cross-validation error)

```{r LASSO Cross-Validation Plot (λ vs CV error)}
plot(lasso_cv)
```

LASSO coefficient path plot

```{r LASSO Coefficient Path Plot}
plot(lasso_cv$glmnet.fit, xvar = "lambda", label = TRUE)
```

```{r}
coef_mat <- as.matrix(coef(lasso_cv, s = "lambda.min"))
coef_df <- tibble(
  variable = rownames(coef_mat),
  coefficient = coef_mat[, 1]
) %>%
  filter(variable != "(Intercept)")
```

Plot of actual vs. predicted revenue (LASSO)

```{r Actual vs Predicted}
pred_lasso_train <- as.numeric(predict(lasso_model, newx = X_train))

training_data_lasso <- training_data %>%
mutate(pred_lasso = pred_lasso_train)

ggplot(training_data_lasso, aes(x = Revenue, y = pred_lasso)) +
geom_point(alpha = 0.7, color = "darkgreen") +
geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
scale_x_continuous(labels = dollar) +
scale_y_continuous(labels = dollar) +
labs(
title = "Actual vs Predicted Revenue (LASSO)",
x = "Actual Revenue",
y = "Predicted Revenue"
) +
theme_minimal(base_size = 13)

```

Correlation map of potential predictors (upper triangle only)

```{r CORR Map}
predictor_mat <- training_data %>%
  select(total_pop, median_income, pct_bachelors, pct_age_20_34,
         pct_urban, pct_poverty) %>%
  as.matrix()

corr_mat <- cor(predictor_mat)

corrplot(
  corr_mat,
  method = "color",
  type = "upper",
  col = viridis(200),   # <-- viridis palette applied here
  tl.col = "black",
  tl.srt = 45
)
```

Scatterplot of revenue vs. each predictor

```{r Rev vs each predictor scatter plot}
plot_df <- training_data %>%
select(Revenue, total_pop, median_income, pct_bachelors,
pct_age_20_34, pct_urban, pct_poverty) %>%
pivot_longer(-Revenue, names_to = "predictor", values_to = "value")

ggplot(plot_df, aes(x = value, y = Revenue)) +
geom_point(alpha = 0.7) +
facet_wrap(~ predictor, scales = "free_x") +
scale_y_continuous(labels = dollar) +
labs(
title = "Revenue vs Key Demographic Predictors (Legal States)",
x = "Predictor Value",
y = "Revenue"
) +
theme_minimal(base_size = 13)
```

Table of model performance comparison between linear model and LASSO

```{r}
# --- Linear Model Predictions ---
lm_pred <- predict(fit_lm)

# --- LASSO Predictions ---
lasso_pred <- as.numeric(predict(lasso_model, newx = X_train))

# --- True values ---
y_true <- training_data$Revenue

# --- Comparison Metrics ---
model_metrics <- tibble(
  Model = c("Linear Model", "LASSO Model"),
  RMSE  = c(rmse(y_true, lm_pred),
            rmse(y_true, lasso_pred)),
  MAE   = c(mae(y_true, lm_pred),
            mae(y_true, lasso_pred)),
  MAPE  = c(mape(y_true, lm_pred),
            mape(y_true, lasso_pred))
)

model_metrics

model_metrics %>%
  mutate(
    RMSE = scales::dollar(RMSE),
    MAE  = scales::dollar(MAE),
    MAPE = scales::percent(MAPE)
  ) %>%
  kable(format = "html", caption = "Model Performance Comparison: Linear Model vs LASSO") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))
```

Column chart of LASSO coefficients at lambda min

```{r}
coef_mat <- as.matrix(coef(lasso_cv, s = "lambda.min"))

coef_df <- tibble(
  variable = rownames(coef_mat),
  coefficient = coef_mat[, "lambda.min"]
) %>%
  filter(variable != "(Intercept)") %>%
  arrange(desc(abs(coefficient)))

coef_df %>%
  mutate(
    coefficient = scales::comma(coefficient)
  ) %>%
  kable(format = "html", caption = "LASSO Feature Importance (λ_min)") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))

ggplot(coef_df, aes(x = reorder(variable, abs(coefficient)), 
                    y = coefficient, 
                    fill = coefficient > 0)) +
  geom_col() +
  coord_flip() +
  scale_fill_manual(values = c("TRUE" = "#1b9e77", "FALSE" = "#d95f02"),
                    guide = "none") +
  labs(
    title = "LASSO Coefficients at λ_min",
    x = "",
    y = "Coefficient Estimate"
  ) +
  theme_minimal(base_size = 13)

```

We compared a standard linear regression to a LASSO regularized model. Both models have sizeable error due to the extreme variability in state gambling revenues. While the linear model slightly outperforms LASSO in RMSE, the LASSO model achieves a much better MAPE (191% vs 344%), indicating more stable performance for low-revenue states.

LASSO also provides valuable model simplification: only two predictors retain nonzero coefficients—pct_age_20_34 and pct_urban—while income, population, poverty, and education are shrunk to zero. This suggests strong multicollinearity among socioeconomic indicators, with LASSO consolidating their predictive signal into a smaller set of variables. The results highlight that demographic structure (pct_age_20_34) and urbanization are the strongest predictors of sports gambling markets.

Go back to [home](home.html)